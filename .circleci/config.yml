version: 2.1

workflows:
  release:
    jobs:
      - release:
          context: [shared-secrets]
          filters:
            branches:
              only: [main]

  release-please:
    jobs:
      - release-please:
          context: [shared-secrets]
          filters:
            branches:
              only: [main]
      - update-lockfile:
          context: [shared-secrets]
          requires:
            - release-please
          filters:
            branches:
              only: [release-please--branches--main]

  'Test & Check üïµÔ∏è‚Äç‚ôÄÔ∏è':
    jobs:
      - formatting

executors:
  node:
    docker:
      - image: cimg/node:18.10.0
  windows:
    machine:
      image: windows-server-2019-vs2019:stable
    resource_class: windows.xlarge
    shell: powershell.exe -ExecutionPolicy Bypass
  linux:
    machine:
      image: ubuntu-2004:202201-02
    resource_class: large
  macos:
    resource_class: macos.x86.medium.gen2 # new generation resources
    macos:
      xcode: 13.0.0

commands:
  npm-install-deps:
    parameters:
      command:
        description: The install command that is used
        type: string
        default: npm ci
    steps:
      - restore_cache:
          keys:
            - npm-{{ arch }}-v1-{{ checksum "package-lock.json" }}
            - npm-{{ arch }}-v1
      - run: << parameters.command >>
      - save_cache:
          key: npm-{{ arch }}-v1-{{ checksum "package-lock.json" }}
          paths:
            - node_modules

jobs:
  release:
    description: The release action that runs on the main branch
    executor: node
    steps:
      - checkout
      - npm-install-deps
      - run: npm run build
      - run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - run: npx lerna publish from-package --yes --no-private
      - run:
          name: Create Github Release
          command: |
            npx release-please github-release \
              --token "${GITHUB_RELEASES_TOKEN}" \
              --repo-url "${CIRCLE_REPOSITORY_URL}" \

  release-please:
    description: Update and creates release PRs on the main branch
    executor: node
    steps:
      - checkout
      - run:
          name: Run release-please
          command: |
            npx release-please release-pr \
              --token "${GITHUB_RELEASES_TOKEN}" \
              --repo-url "${CIRCLE_REPOSITORY_URL}" \

  update-lockfile:
    description: Update lockfile in a release please PR
    executor: node
    steps:
      - run: git clone -b "release-please--branches--main" "$CIRCLE_REPOSITORY_URL" --depth=2
      - run: npm install
      - run:
          name: Commit and push lockfile
          command: |
            git config user.name "$(git log -n 1 --pretty=format:%an)" && \
            git config user.email "$(git log -n 1 --pretty=format:%ae)" && \
            git add package-lock.json && \
            git commit --amend --no-edit && \
            git push --force

  formatting:
    description: Checks if the codebase satisfies wit the lint and style rules
    executor: node
    steps:
      - checkout
      - npm-install-deps
      - run: npm run format:ci
      - run: npm run lint:ci
