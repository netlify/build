<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Framework Info Vanilla JS Site</title>
  </head>
  <body>
    <script src="../index.js"></script>
    <script>
      const repo = 'netlify-templates/gatsby-starter-netlify-cms'

      const get = async (path = '') => {
        const response = await fetch(`https://api.github.com/repos/${repo}${path}`)
        return response.json()
      }

      const listFiles = async () => {
        const { default_branch: defaultBranch } = await get()
        const { tree } = await get(`/git/trees/${defaultBranch}?recursive=1`)
        return tree.map(({ path }) => path)
      }

      const getPackageJson = async () => {
        const { content } = await get('/contents/package.json')
        const raw = atob(content)
        return JSON.parse(raw)
      }

      const getContext = async () => {
        const [repoFiles, packageJson] = await Promise.all([listFiles(), getPackageJson()])
        const pathExists = (path) => {
          const normalizedPath = path.startsWith('./') ? path.slice(2) : path
          return repoFiles.includes(normalizedPath)
        }
        return { pathExists, packageJson }
      }

      const getFrameworks = async () => {
        const context = await getContext()
        const frameworks = await frameworkInfo.listFrameworks(context)
        return frameworks
      }

      getFrameworks()
        .then((frameworks) => {
          const body = document.querySelector('body')
          frameworks.forEach((framework) => {
            const div = document.createElement('div')
            div.setAttribute('id', framework.name)
            // eslint-disable-next-line fp/no-mutation
            div.textContent = JSON.stringify(framework)
            body.append(div)
          })
          return frameworks
        })
        .catch((error) => {
          console.log(error)
        })
    </script>
  </body>
</html>
