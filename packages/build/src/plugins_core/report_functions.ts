import { closeClient, formatTags, InputStatsDOptions, startClient, validateStatsDOptions } from '../report/statsd.js'

/**
 * Record number of functions build and differentiate between autogenerated and user generated.
 * Sends to statsd daemon.
 */
export const reportFunctions = async function (statsdOpts: InputStatsDOptions, metrics): Promise<void> {
  if (!validateStatsDOptions(statsdOpts)) {
    return
  }

  const edgeFunctionMetrics = metrics.find((metric) => metric.type === 'edge_functions')

  if (!edgeFunctionMetrics) {
    return
  }

  const { numGenEfs, numUserEfs } = edgeFunctionMetrics

  const client = await startClient(statsdOpts)

  client.increment('buildbot.build.functions', numGenEfs, formatTags({ type: 'edge:generated' }))
  client.increment('buildbot.build.functions', numUserEfs, formatTags({ type: 'edge:user' }))

  await closeClient(client)
}
