# Snapshot report for `packages/build/tests/telemetry/tests.js`

The actual snapshot is saved in `tests.js.snap`.

Generated by [AVA](https://ava.li).

## Telemetry calls timeout by default

> Snapshot 1

    `␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build                                                 ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    > Version␊
      @netlify/build 1.0.0␊
    ␊
    > Flags␊
      debug: true␊
      repositoryRoot: packages/build/tests/telemetry/fixtures/success␊
      siteId: test␊
      testOpts:␊
        errorMonitor: true␊
        pluginsListUrl: test␊
        silentLingeringProcesses: true␊
        telemetryOrigin: /test/socket␊
    ␊
    > Current directory␊
      packages/build/tests/telemetry/fixtures/success␊
    ␊
    > Config file␊
      packages/build/tests/telemetry/fixtures/success/netlify.toml␊
    ␊
    > Resolved config␊
      {}␊
    ␊
    > Context␊
      production␊
    ␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build Complete                                        ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    (Netlify Build completed in 1ms)␊
    ␊
    Error monitoring payload:␊
    {␊
      "errorClass": "telemetry",␊
      "errorMessage": "Timeout awaiting 'request' for 1ms",␊
      "context": "Telemetry error",␊
      "groupingHash": "Telemetry error/nTimeout awaiting 'request' for 1ms",␊
      "severity": "error",␊
      "unhandled": true,␊
      "pluginPackageJson": false,␊
      "other": {␊
        "groupingHash": "Telemetry error/nTimeout awaiting 'request' for 1ms"␊
      }␊
    }`

## Telemetry error only reports to error monitor and does not affect build success

> Snapshot 1

    `␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build                                                 ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    > Version␊
      @netlify/build 1.0.0␊
    ␊
    > Flags␊
      debug: true␊
      repositoryRoot: packages/build/tests/telemetry/fixtures/success␊
      siteId: test␊
      testOpts:␊
        errorMonitor: 'true'␊
        pluginsListUrl: test␊
        silentLingeringProcesses: 'true'␊
        telemetryOrigin: /test/socket␊
        telemetryTimeout: 'null'␊
    ␊
    > Current directory␊
      packages/build/tests/telemetry/fixtures/success␊
    ␊
    > Config file␊
      packages/build/tests/telemetry/fixtures/success/netlify.toml␊
    ␊
    > Resolved config␊
      {}␊
    ␊
    > Context␊
      production␊
    ␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build Complete                                        ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    (Netlify Build completed in 1ms)␊
    ␊
    Error monitoring payload:␊
    {␊
      "errorClass": "telemetry",␊
      "errorMessage": "Response code 500 (Internal Server Error)",␊
      "context": "Telemetry error",␊
      "groupingHash": "Telemetry error/nResponse code 0 (Internal Server Error)",␊
      "severity": "error",␊
      "unhandled": true,␊
      "pluginPackageJson": false,␊
      "other": {␊
        "groupingHash": "Telemetry error/nResponse code 0 (Internal Server Error)"␊
      }␊
    }`

## Telemetry reports build cancellation

> Snapshot 1

    [
      {
        body: {
          event: 'build:ci_build_process_completed',
          properties: {
            buildVersion: 'string',
            nodeVersion: 'string',
            osName: 'string',
            osPlatform: 'string',
            pluginCount: 1,
            plugins: [
              {
                loadedFrom: 'local',
                name: './plugin.js',
                nodeVersion: 'string',
                origin: 'config',
                version: 'string',
              },
            ],
            siteId: 'test',
            status: 'cancelled',
          },
          timestamp: 'number',
          userId: 'buildbot_user',
        },
        headers: 'accept accept-encoding authorization connection content-length content-type host user-agent',
        method: 'POST',
        url: '/track',
      },
    ]

## Telemetry reports build success

> Snapshot 1

    [
      {
        body: {
          event: 'build:ci_build_process_completed',
          properties: {
            buildVersion: 'string',
            duration: 'number',
            nodeVersion: 'string',
            osName: 'string',
            osPlatform: 'string',
            pluginCount: 0,
            plugins: [],
            siteId: 'test',
            status: 'success',
            steps: 0,
          },
          timestamp: 'number',
          userId: 'buildbot_user',
        },
        headers: 'accept accept-encoding authorization connection content-length content-type host user-agent',
        method: 'POST',
        url: '/track',
      },
    ]

## Telemetry reports plugin error

> Snapshot 1

    [
      {
        body: {
          event: 'build:ci_build_process_completed',
          properties: {
            buildVersion: 'string',
            nodeVersion: 'string',
            osName: 'string',
            osPlatform: 'string',
            pluginCount: 1,
            plugins: [
              {
                loadedFrom: 'local',
                name: './plugin.js',
                nodeVersion: 'string',
                origin: 'config',
                version: 'string',
              },
            ],
            siteId: 'test',
            status: 'plugin-error',
          },
          timestamp: 'number',
          userId: 'buildbot_user',
        },
        headers: 'accept accept-encoding authorization connection content-length content-type host user-agent',
        method: 'POST',
        url: '/track',
      },
    ]

## Telemetry reports user error

> Snapshot 1

    [
      {
        body: {
          event: 'build:ci_build_process_completed',
          properties: {
            buildVersion: 'string',
            nodeVersion: 'undefined',
            osName: 'string',
            osPlatform: 'string',
            status: 'user-error',
          },
          timestamp: 'number',
          userId: 'buildbot_user',
        },
        headers: 'accept accept-encoding authorization connection content-length content-type host user-agent',
        method: 'POST',
        url: '/track',
      },
    ]

## Telemetry success generates no logs

> Snapshot 1

    `␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build                                                 ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    > Version␊
      @netlify/build 1.0.0␊
    ␊
    > Flags␊
      debug: true␊
      repositoryRoot: packages/build/tests/telemetry/fixtures/success␊
      siteId: test␊
      testOpts:␊
        errorMonitor: true␊
        pluginsListUrl: test␊
        silentLingeringProcesses: true␊
        telemetryOrigin: /test/socket␊
        telemetryTimeout: null␊
    ␊
    > Current directory␊
      packages/build/tests/telemetry/fixtures/success␊
    ␊
    > Config file␊
      packages/build/tests/telemetry/fixtures/success/netlify.toml␊
    ␊
    > Resolved config␊
      {}␊
    ␊
    > Context␊
      production␊
    ␊
    ────────────────────────────────────────────────────────────────␊
      Netlify Build Complete                                        ␊
    ────────────────────────────────────────────────────────────────␊
    ␊
    (Netlify Build completed in 1ms)`
